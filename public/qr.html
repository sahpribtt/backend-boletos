<!DOCTYPE html>
<html>
<head>
    <title>Conectar WhatsApp - Sistema de Boletos</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            display: inline-block;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 500px;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .qr-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            min-height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #qrImage {
            max-width: 250px;
            border: 1px solid #ddd;
            border-radius: 10px;
            display: none;
        }
        .loading {
            font-size: 18px;
            color: #667eea;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        button:hover {
            background: #5a67d8;
        }
        .instructions {
            text-align: left;
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Conectar WhatsApp</h1>
        <p>Sistema de Envio Autom√°tico de Boletos</p>
        
        <div class="qr-container">
            <div id="loading" class="loading">
                <p>üîÑ Iniciando WhatsApp...</p>
                <p>Aguarde at√© 30 segundos</p>
            </div>
            
            <div id="qrContent" style="display: none;">
                <p><strong>Escaneie este c√≥digo:</strong></p>
                <img id="qrImage" alt="QR Code WhatsApp">
                <p style="margin-top: 15px; color: #666;">
                    Use o WhatsApp no seu celular para escanear
                </p>
            </div>
        </div>
        
        <div id="statusMessage" class="status disconnected">
            Aguardando in√≠cio do WhatsApp...
        </div>
        
        <div class="instructions">
            <p><strong>Como conectar:</strong></p>
            <ol>
                <li>Abra o WhatsApp no seu celular</li>
                <li>Toque em ‚ãÆ (tr√™s pontos) ‚Üí "Dispositivos conectados"</li>
                <li>Toque em "Conectar um dispositivo"</li>
                <li>Aponte a c√¢mera para o c√≥digo acima</li>
                <li>Aguarde a confirma√ß√£o</li>
            </ol>
        </div>
        
        <div>
            <button onclick="loadQRCode()">üîÑ Atualizar QR Code</button>
            <button onclick="checkStatus()">üîç Verificar Status</button>
            <button onclick="window.open('/api/test', '_blank')">üìä Testar API</button>
        </div>
        
        <div style="margin-top: 20px; font-size: 14px; color: #666;">
            <p>URL do QR: <code id="qrUrl"></code></p>
            <p>Status: <span id="statusText">Desconectado</span></p>
        </div>
    </div>
    
    <script>
        // Mostra a URL atual
        document.getElementById('qrUrl').textContent = window.location.href;
        
        async function loadQRCode() {
            const loading = document.getElementById('loading');
            const qrContent = document.getElementById('qrContent');
            const qrImage = document.getElementById('qrImage');
            const statusMessage = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            
            // Mostra loading
            loading.style.display = 'block';
            qrContent.style.display = 'none';
            statusMessage.textContent = 'üîÑ Solicitando QR Code...';
            statusMessage.className = 'status disconnected';
            
            try {
                console.log('Solicitando QR Code...');
                
                // Usa timeout longo para o Venom iniciar
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 segundos
                
                const response = await fetch('/api/venom/qr', {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                console.log('Resposta:', data);
                
                if (data.status === 'qr_ready' && data.qrCode) {
                    // QR Code pronto
                    qrImage.src = data.qrCode;
                    loading.style.display = 'none';
                    qrContent.style.display = 'block';
                    
                    statusMessage.textContent = '‚úÖ QR Code pronto! Escaneie agora.';
                    statusMessage.className = 'status disconnected';
                    statusText.textContent = 'QR Code dispon√≠vel';
                    
                    // Inicia verifica√ß√£o autom√°tica
                    setTimeout(checkStatus, 5000);
                    
                } else if (data.status === 'initializing') {
                    // Ainda iniciando
                    statusMessage.textContent = 'üîÑ ' + data.message;
                    statusMessage.className = 'status disconnected';
                    statusText.textContent = 'Iniciando...';
                    
                    // Tenta novamente em 5 segundos
                    setTimeout(loadQRCode, 5000);
                    
                } else {
                    // Outro status
                    statusMessage.textContent = '‚ÑπÔ∏è ' + (data.message || 'Status desconhecido');
                    statusMessage.className = 'status disconnected';
                    statusText.textContent = 'Aguardando';
                    setTimeout(loadQRCode, 5000);
                }
                
            } catch (error) {
                console.error('Erro:', error);
                
                if (error.name === 'AbortError') {
                    statusMessage.textContent = '‚è∞ Tempo esgotado! O WhatsApp est√° demorando para iniciar.';
                    statusText.textContent = 'Timeout';
                } else {
                    statusMessage.textContent = '‚ùå Erro: ' + error.message;
                    statusText.textContent = 'Erro de conex√£o';
                }
                
                statusMessage.className = 'status disconnected';
                
                // Tenta novamente em 10 segundos
                setTimeout(loadQRCode, 10000);
            }
        }
        
        async function checkStatus() {
            try {
                const response = await fetch('/api/venom/status');
                const data = await response.json();
                
                const statusMessage = document.getElementById('statusMessage');
                const statusText = document.getElementById('statusText');
                
                if (data.connected) {
                    statusMessage.textContent = '‚úÖ WhatsApp CONECTADO com sucesso!';
                    statusMessage.className = 'status connected';
                    statusText.textContent = 'Conectado';
                    
                    // Pode fechar esta p√°gina ou continuar
                    document.getElementById('qrContent').style.display = 'none';
                    document.getElementById('loading').innerHTML = 
                        '<p>üéâ WhatsApp conectado!</p>' +
                        '<p>Pode fechar esta p√°gina e usar o sistema.</p>';
                    
                } else {
                    statusMessage.textContent = 'üî¥ Aguardando escaneamento do QR Code...';
                    statusMessage.className = 'status disconnected';
                    statusText.textContent = 'Desconectado';
                    
                    // Continua verificando
                    setTimeout(checkStatus, 5000);
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                setTimeout(checkStatus, 10000);
            }
        }
        
        // Inicia quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            loadQRCode();
            // Verifica status a cada 10 segundos
            setInterval(checkStatus, 10000);
        });
        
        // Atualiza a cada 30 segundos se ainda n√£o conectou
        setInterval(() => {
            const statusText = document.getElementById('statusText').textContent;
            if (statusText !== 'Conectado') {
                loadQRCode();
            }
        }, 30000);
    </script>
</body>
</html>
